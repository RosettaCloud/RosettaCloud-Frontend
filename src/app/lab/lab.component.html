<div class="lab-container">
  <!-- ────────── HEADER ────────── -->
  <header class="lab-header">
    <div class="lab-title">
      <h4>DevLab</h4>
      <div class="lab-status" *ngIf="labInfo$ | async as labInfo">
        <span
          class="status-indicator"
          [ngClass]="{
            active: labInfo.status === 'running',
            error: labInfo.status === 'error',
            pending: labInfo.status === 'pending'
          }"
        ></span>
        <span class="status-text">{{ labInfo.status | titlecase }}</span>
        <span class="time-remaining" *ngIf="timeRemaining$ | async as t">
          <i class="bi bi-clock"></i> {{ t }}
        </span>
      </div>
    </div>

    <div class="lab-actions">
      <button
        class="btn-terminate"
        [disabled]="!isLabActive"
        (click)="terminateLab()"
      >
        <i class="bi bi-stop-circle"></i> Terminate
      </button>
    </div>
  </header>

  <!-- connection banner -->
  <div class="api-connection-warning" *ngIf="!isApiConnected && !isLabActive">
    <i class="bi bi-wifi-off"></i> Connection to lab service lost. Retrying…
  </div>

  <!-- ────────── MAIN LAYOUT ────────── -->
  <div class="lab-content">
    <!-- ░░ Sidebar ░░ -->
    <aside class="lab-sidebar">
      <div class="sidebar-header"><h5>Lab Questions</h5></div>

      <!-- navigation -->
      <div class="question-navigation" *ngIf="questions.length">
        <button
          class="nav-btn"
          (click)="navigateToPrevQuestion()"
          [disabled]="currentQuestionIndex === 0"
        >
          &lt;
        </button>

        <div class="question-indicators">
          <div
            *ngFor="let q of questions; let i = index"
            class="question-indicator"
            [ngClass]="{
              active: currentQuestionIndex === i,
              visited: q.visited,
              completed: q.completed
            }"
            (click)="navigateToQuestion(i + 1)"
          >
            {{ i + 1 }}
          </div>
        </div>

        <button
          class="nav-btn"
          (click)="navigateToNextQuestion()"
          [disabled]="currentQuestionIndex === questions.length - 1"
        >
          &gt;
        </button>
      </div>

      <!-- scrollable question body -->
      <div class="question-details" *ngIf="currentQuestion as cq">
        <h5 class="question-title">{{ cq.question }}</h5>

        <!-- MCQ list -->
        <div
          class="question-options"
          *ngIf="cq.type === 'mcq' && cq.options?.length"
        >
          <div
            *ngFor="let opt of cq.options; let i = index"
            class="option-item"
            [ngClass]="{
              selected: selectedOption === i,
              correct: showFeedback && selectedOption === i && isAnswerCorrect,
              incorrect:
                showFeedback && selectedOption === i && !isAnswerCorrect
            }"
            (click)="setSelectedOption(i)"
          >
            <div class="option-marker">{{ ["A", "B", "C", "D", "E"][i] }}</div>
            <div class="option-text">{{ opt }}</div>
          </div>
        </div>

        <!-- feedback -->
        <div class="feedback-area" *ngIf="showFeedback">
          <div
            class="feedback-message"
            [ngClass]="{
              'feedback-correct': isAnswerCorrect,
              'feedback-incorrect': !isAnswerCorrect
            }"
          >
            {{ feedbackMessage }}
          </div>
        </div>
      </div>

      <!-- fixed footer: progress + buttons -->
      <div class="sidebar-footer" *ngIf="questions.length">
        <!-- progress -->
        <div class="progress-indicator">
          <div class="progress-text">
            {{ getCompletedQuestionsCount() }} /
            {{ questions.length }} completed
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="
                (getCompletedQuestionsCount() / questions.length) * 100
              "
            ></div>
          </div>
        </div>

        <!-- action buttons -->
        <div class="question-actions" *ngIf="currentQuestion as cq">
          <!-- check / submit -->
          <button
            class="btn-check"
            *ngIf="cq.type === 'mcq' && !showFeedback && !cq.completed"
            [disabled]="
              selectedOption === null || !isLabActive || checkInProgress
            "
            (click)="checkAnswer()"
          >
            Check
          </button>

          <button
            class="btn-check"
            *ngIf="cq.type === 'check' && !showFeedback && !cq.completed"
            [disabled]="!isLabActive || checkInProgress"
            (click)="checkQuestion(currentQuestionIndex + 1)"
          >
            Check
          </button>

          <!-- next / skip -->
          <button
            class="btn-next"
            *ngIf="
              ((showFeedback && isAnswerCorrect) || cq.completed) &&
              currentQuestionIndex < questions.length - 1
            "
            (click)="navigateToNextQuestion()"
          >
            Next Question
          </button>

          <button
            class="btn-skip"
            *ngIf="showFeedback && !isAnswerCorrect && !cq.completed"
            (click)="navigateToNextQuestion()"
          >
            Skip
          </button>
        </div>
      </div>
    </aside>

    <!-- ░░ Main panel ░░ -->
    <main class="lab-main">
      <!-- loading -->
      <div class="lab-loading" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>
          {{ isInitializing ? "Initializing lab environment…" : "Loading…" }}
        </p>
      </div>

      <!-- error -->
      <div class="lab-error" *ngIf="!isLoading && errorMessage">
        <div class="error-icon"><i class="bi bi-exclamation-triangle"></i></div>
        <h5>Oops! Something went wrong</h5>
        <p>{{ errorMessage }}</p>
        <button class="btn-retry" (click)="initializeNewLab()">
          Try Again
        </button>
      </div>

      <!-- running lab -->
      <div class="lab-frame" *ngIf="!isLoading && isLabActive && codeServerUrl">
        <iframe
          class="code-server-iframe"
          [src]="codeServerUrl"
          allowfullscreen
          title="Lab Environment"
        ></iframe>
      </div>
    </main>
  </div>
</div>
