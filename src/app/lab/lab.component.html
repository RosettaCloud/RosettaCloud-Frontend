<div class="lab-container">
  <!-- Lab Header with Status and Actions -->
  <header class="lab-header">
    <div class="lab-title">
      <h4>DevLab</h4>
      <div class="lab-status" *ngIf="labInfo$ | async as labInfo">
        <span
          class="status-indicator"
          [ngClass]="{
            active: labInfo.status === 'running',
            error: labInfo.status === 'error',
            pending: labInfo.status === 'pending'
          }"
        ></span>
        <span class="status-text">{{ labInfo.status | titlecase }}</span>
        <span
          class="time-remaining"
          *ngIf="timeRemaining$ | async as timeRemaining"
        >
          <i class="bi bi-clock"></i> {{ timeRemaining }}
        </span>
      </div>
    </div>

    <div class="lab-actions">
      <!-- Restart button hidden as requested -->
      <button
        class="btn btn-terminate"
        [disabled]="!isLabActive"
        (click)="terminateLab()"
      >
        <i class="bi bi-stop-circle"></i> Terminate
      </button>
    </div>
  </header>

  <!-- API Connection Warning - Only shows when connection is lost and lab is not active -->
  <div class="api-connection-warning" *ngIf="!isApiConnected && !isLabActive">
    <i class="bi bi-wifi-off"></i> Connection to lab service lost. Retrying...
  </div>

  <!-- Main Content Area -->
  <div class="lab-content">
    <!-- Left Panel: Questions & Instructions -->
    <aside class="lab-sidebar">
      <div class="sidebar-header">
        <h5>Lab Questions</h5>
      </div>

      <!-- Enhanced Question Navigation Bar -->
      <div class="question-navigation" *ngIf="questions.length > 0">
        <button
          class="nav-btn prev-btn"
          (click)="navigateToPrevQuestion()"
          [disabled]="currentQuestionIndex === 0"
        >
          <i class="bi bi-chevron-left"></i>
        </button>

        <div class="question-indicators">
          <div
            *ngFor="let question of questions; let i = index"
            class="question-indicator"
            [ngClass]="{
              active: currentQuestionIndex === i,
              visited: question.visited,
              completed: question.completed
            }"
          >
            {{ i + 1 }}
          </div>
        </div>

        <button
          class="nav-btn next-btn"
          (click)="navigateToNextQuestion()"
          [disabled]="currentQuestionIndex === questions.length - 1"
        >
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>

      <!-- Current Question Details -->
      <div class="question-details" *ngIf="currentQuestion">
        <h5 class="question-title">Question {{ currentQuestionIndex + 1 }}</h5>
        <div
          class="question-description"
          [innerHTML]="currentQuestion.description"
        ></div>

        <button
          class="btn-check"
          (click)="checkQuestion(currentQuestionIndex + 1)"
          [disabled]="!isLabActive || currentQuestion.completed"
        >
          <i class="bi bi-check2-circle"></i>
          {{ currentQuestion.completed ? "Completed" : "Check Answer" }}
        </button>

        <button
          *ngIf="
            currentQuestion.completed &&
            currentQuestionIndex < questions.length - 1
          "
          class="btn-next"
          (click)="navigateToNextQuestion()"
        >
          <i class="bi bi-arrow-right"></i> Next Question
        </button>
      </div>
    </aside>

    <!-- Main Lab Display Area -->
    <main class="lab-main">
      <!-- Loading State -->
      <div class="lab-loading" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>
          {{
            isInitializing ? "Initializing lab environment..." : "Loading..."
          }}
        </p>
      </div>

      <!-- Error State -->
      <div class="lab-error" *ngIf="!isLoading && errorMessage">
        <div class="error-icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h5>Oops! Something went wrong</h5>
        <p>{{ errorMessage }}</p>
        <button class="btn-retry" (click)="initializeNewLab()">
          Try Again
        </button>
      </div>

      <!-- Lab Frame (Code Server) -->
      <div class="lab-frame" *ngIf="!isLoading && isLabActive && codeServerUrl">
        <iframe
          class="code-server-iframe"
          [src]="codeServerUrl"
          allowfullscreen
          title="Lab Environment"
        ></iframe>
      </div>
    </main>
  </div>
</div>
