<!-- lab.component.html -->
<div class="lab-container">
  <!-- ───── HEADER ───── -->
  <header class="lab-header">
    <div class="lab-title">
      <h4>DevLab</h4>
      <div class="lab-status" *ngIf="labInfo$ | async as labInfo">
        <span
          class="status-indicator"
          [ngClass]="{
            active: labInfo.status === 'running',
            error: labInfo.status === 'error',
            pending: labInfo.status === 'pending'
          }"
        ></span>
        <span class="status-text">{{ labInfo.status | titlecase }}</span>
        <span class="time-remaining" *ngIf="timeRemaining$ | async as t">
          <i class="bi bi-clock"></i>{{ t }}
        </span>
      </div>
    </div>

    <div class="lab-actions">
      <button
        class="btn-terminate"
        (click)="terminateLab()"
        [disabled]="!isLabActive"
      >
        <i class="bi bi-stop-circle"></i> Terminate
      </button>
    </div>
  </header>

  <!-- connection lost banner -->
  <div class="api-connection-warning" *ngIf="showApiBanner">
    <i class="bi bi-wifi-off wifi-icon"></i> Connection to lab service lost.
    Retrying…
  </div>

  <!-- ───── MAIN LAYOUT ───── -->
  <div class="lab-content">
    <!-- ░░ Sidebar ░░ -->
    <aside class="lab-sidebar">
      <div class="sidebar-header"><h5>Lab Questions</h5></div>

      <!-- navigation bar -->
      <div class="question-navigation" *ngIf="questions.length">
        <button
          class="nav-btn"
          (click)="navigateToPrevQuestion()"
          [disabled]="currentQuestionIndex === 0"
        >
          &lt;
        </button>

        <div class="question-indicators">
          <div
            *ngFor="let q of questions; let i = index"
            class="question-indicator"
            [ngClass]="{
              active: currentQuestionIndex === i,
              visited: q.visited,
              completed: q.completed
            }"
            (click)="navigateToQuestion(i + 1)"
          >
            {{ i + 1 }}
          </div>
        </div>

        <button
          class="nav-btn"
          (click)="navigateToNextQuestion()"
          [disabled]="currentQuestionIndex === questions.length - 1"
        >
          &gt;
        </button>
      </div>

      <!-- question body -->
      <div class="question-details" *ngIf="currentQuestion as cq">
        <h5 class="question-title">{{ cq.question }}</h5>

        <!-- MCQ options -->
        <div
          class="question-options"
          *ngIf="cq.type === 'mcq' && cq.options?.length"
        >
          <div
            *ngFor="let opt of cq.options; let i = index"
            class="option-item"
            [ngClass]="{
              selected: selectedOption === i,
              correct: showFeedback && selectedOption === i && isAnswerCorrect,
              incorrect:
                showFeedback && selectedOption === i && !isAnswerCorrect,
              'disabled-wrong': cq.disabledOptions.includes(i)
            }"
            (click)="setSelectedOption(i)"
          >
            <div class="option-marker">{{ ["A", "B", "C", "D", "E"][i] }}</div>
            <div class="option-text">{{ opt }}</div>
          </div>
        </div>

        <!-- feedback -->
        <div class="feedback-area" *ngIf="showFeedback">
          <div
            class="feedback-message"
            [ngClass]="{
              'feedback-correct': isAnswerCorrect,
              'feedback-incorrect': !isAnswerCorrect
            }"
          >
            {{ feedbackMessage }}
          </div>
        </div>

        <!-- buttons under answers -->
        <div class="question-buttons">
          <!-- submit/check -->
          <button
            class="btn-submit"
            [ngClass]="{ loading: checkInProgress }"
            *ngIf="cq.type === 'mcq' && !cq.completed"
            [disabled]="
              selectedOption === null || !isLabActive || checkInProgress
            "
            (click)="checkAnswer()"
          >
            <span class="spinner" *ngIf="checkInProgress"></span>
            <span class="btn-text">Submit</span>
          </button>
          <button
            class="btn-submit"
            [ngClass]="{ loading: checkInProgress }"
            *ngIf="cq.type === 'check' && !cq.completed"
            [disabled]="checkInProgress || !isLabActive"
            (click)="checkQuestion(currentQuestionIndex + 1)"
          >
            <span class="spinner" *ngIf="checkInProgress"></span>
            <span class="btn-text">Check</span>
          </button>

          <!-- next / skip -->
          <button
            class="btn-next"
            *ngIf="
              (cq.completed || (showFeedback && isAnswerCorrect)) &&
              currentQuestionIndex < questions.length - 1
            "
            (click)="navigateToNextQuestion()"
          >
            Next Question
          </button>

          <button
            class="btn-skip"
            *ngIf="
              cq.wrongAttempt &&
              !cq.completed &&
              currentQuestionIndex < questions.length - 1
            "
            (click)="navigateToNextQuestion()"
          >
            Skip
          </button>
        </div>
      </div>
      <div class="lab-feedback-section" *ngIf="showFeedbackButton">
        <app-feedback
          [moduleUuid]="moduleUuid ?? ''"
          [lessonUuid]="lessonUuid ?? ''"
          [questions]="questions"
          [userProgress]="userProgressData"
          (terminateLabRequest)="terminateLab()"
        ></app-feedback>
      </div>
      <!-- footer with progress -->
      <div class="sidebar-footer" *ngIf="questions.length">
        <div class="progress-indicator">
          <div class="progress-text">
            {{ getCompletedQuestionsCount() }}/{{ questions.length }} completed
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="
                (getCompletedQuestionsCount() / questions.length) * 100
              "
            ></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ░░ Main panel ░░ -->
    <main class="lab-main">
      <!-- loading overlay -->
      <div class="lab-loading" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>
          {{
            isInitializing
              ? "Initializing lab environment this may take up to 1 minute…"
              : "Loading…"
          }}
        </p>
      </div>

      <!-- error overlay -->
      <div class="lab-error" *ngIf="!isLoading && errorMessage">
        <div class="error-icon"><i class="bi bi-exclamation-triangle"></i></div>
        <h5>Oops! Something went wrong</h5>
        <p>{{ errorMessage }}</p>
        <button class="btn-retry" (click)="initializeNewLab()">
          Try Again
        </button>
      </div>

      <!-- running lab -->
      <div class="lab-frame" *ngIf="!isLoading && isLabActive && codeServerUrl">
        <iframe
          class="code-server-iframe"
          [src]="codeServerUrl"
          title="Lab Environment"
        ></iframe>
      </div>
    </main>
  </div>
  <app-chatbot></app-chatbot>
</div>
