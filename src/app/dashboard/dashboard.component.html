<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading your dashboard...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="container py-5">
    <div class="alert alert-danger" role="alert">
      {{ errorMessage }}
    </div>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && !errorMessage" class="container py-5">
    <!-- Welcome Banner -->
    <div class="welcome-banner mb-5">
      <div class="row align-items-center">
        <div class="col-md-7">
          <h1 class="welcome-title">
            Welcome back, {{ user?.name || "Student" }}!
          </h1>
          <p class="welcome-subtitle">
            Track your progress and continue your learning journey
          </p>
        </div>
        <div class="col-md-5 text-md-end mt-3 mt-md-0">
          <a routerLink="/courses" class="btn btn-primary me-2">
            <i class="bi bi-book me-2"></i>Explore Courses
          </a>
          <a routerLink="/profile" class="btn btn-outline-primary">
            <i class="bi bi-person me-2"></i>My Profile
          </a>
        </div>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="row mb-5">
      <div class="col-md-4 mb-4 mb-md-0">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-book"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ userModules?.length || 0 }}</h3>
            <p class="stat-label">Enrolled Courses</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4 mb-md-0">
        <div class="stat-card">
          <div class="stat-icon bg-success">
            <i class="bi bi-check-lg"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ completedLessons }}</h3>
            <p class="stat-label">Completed Lessons</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-icon bg-info">
            <i class="bi bi-code-square"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ userLabs?.length || 0 }}</h3>
            <p class="stat-label">Active Labs</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Course Progress -->
    <div class="card shadow mb-5">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">Your Learning Progress</h5>
        <a routerLink="/courses" class="btn btn-sm btn-outline-primary"
          >View All Courses</a
        >
      </div>
      <div class="card-body p-4">
        <!-- Empty State -->
        <div
          *ngIf="!userProgress || Object.keys(userProgress).length === 0"
          class="text-center py-4"
        >
          <div class="empty-state">
            <i class="bi bi-journal-text display-1"></i>
            <h4 class="mt-3">No courses started yet</h4>
            <p class="text-muted">
              Enroll in a course to start your learning journey
            </p>
            <a routerLink="/courses" class="btn btn-primary mt-2"
              >Browse Courses</a
            >
          </div>
        </div>

        <!-- Course List -->
        <div
          *ngIf="userProgress && Object.keys(userProgress).length > 0"
          class="course-list"
        >
          <div
            *ngFor="let moduleId of userModules; let i = index"
            class="course-item"
            [class.border-bottom]="i < userModules.length - 1"
          >
            <h5 class="course-title">Module: {{ moduleId }}</h5>

            <!-- Progress Overview -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <span class="badge rounded-pill bg-primary me-2"
                  >{{ getModuleLessons(moduleId).length }} lessons</span
                >
                <span class="text-muted small"
                  >{{ getModuleCompletionPercentage(moduleId) }}% complete</span
                >
              </div>
              <a
                [routerLink]="['/courses', moduleId]"
                class="btn btn-sm btn-primary"
                >Continue Learning</a
              >
            </div>

            <!-- Module Progress Bar -->
            <div class="progress mb-4" style="height: 10px">
              <div
                class="progress-bar"
                [style.width.%]="getModuleCompletionPercentage(moduleId)"
              ></div>
            </div>

            <!-- Lesson List (Collapsed) -->
            <div class="lesson-list" *ngIf="expandedModules[moduleId]">
              <div
                *ngFor="let lessonId of getModuleLessons(moduleId)"
                class="lesson-item"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <div
                      class="lesson-status"
                      [ngClass]="{
                        completed: isLessonCompleted(moduleId, lessonId)
                      }"
                    >
                      <i
                        class="bi"
                        [ngClass]="
                          isLessonCompleted(moduleId, lessonId)
                            ? 'bi-check-lg'
                            : 'bi-circle'
                        "
                      ></i>
                    </div>
                    <span class="lesson-name">{{ lessonId }}</span>
                  </div>
                  <div class="lesson-progress">
                    <span class="small"
                      >{{ getCompletedQuestionsCount(moduleId, lessonId) }}/{{
                        getTotalQuestionsCount(moduleId, lessonId)
                      }}</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Toggle Expand Button -->
            <button
              class="btn btn-link btn-sm text-decoration-none p-0 mt-2"
              (click)="toggleModuleExpand(moduleId)"
            >
              {{ expandedModules[moduleId] ? "Hide lessons" : "Show lessons" }}
              <i
                class="bi"
                [ngClass]="
                  expandedModules[moduleId]
                    ? 'bi-chevron-up'
                    : 'bi-chevron-down'
                "
              ></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Labs -->
    <div class="card shadow">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">Your Active Labs</h5>
        <a routerLink="/labs" class="btn btn-sm btn-outline-primary"
          >View All Labs</a
        >
      </div>
      <div class="card-body p-4">
        <!-- Empty State -->
        <div
          *ngIf="!userLabs || userLabs.length === 0"
          class="text-center py-4"
        >
          <div class="empty-state">
            <i class="bi bi-pc-display-horizontal display-1"></i>
            <h4 class="mt-3">No active labs</h4>
            <p class="text-muted">
              Access hands-on labs to practice your skills
            </p>
            <a routerLink="/labs" class="btn btn-primary mt-2">Browse Labs</a>
          </div>
        </div>

        <!-- Labs List -->
        <div *ngIf="userLabs && userLabs.length > 0" class="row g-4">
          <div *ngFor="let labId of userLabs" class="col-md-6 col-lg-4">
            <div class="lab-card">
              <div class="lab-status">
                <span class="badge rounded-pill bg-success">Active</span>
              </div>
              <div class="lab-icon">
                <i class="bi bi-pc-display-horizontal"></i>
              </div>
              <h5 class="lab-title">Lab: {{ labId }}</h5>
              <p class="lab-description">
                Access hands-on environment to practice your skills
              </p>
              <div class="d-grid">
                <a [routerLink]="['/labs', labId]" class="btn btn-primary"
                  >Launch Lab</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
